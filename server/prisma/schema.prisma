generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid()) @db.VarChar(30)
  username  String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  name      String?  @db.VarChar(100)
  role      String   @default("admin") @db.VarChar(20)
  createdAt DateTime @default(now())
  auditLogs AuditLog[]

  @@map("user")
}

model Computer {
  id          String   @id @default(cuid()) @db.VarChar(30)
  hostname    String   @unique @db.VarChar(191)
  ipAddress   String   @db.VarChar(45)
  macAddress  String?  @db.VarChar(50)
  osVersion   String?  @db.VarChar(255)
  department  String   @default("General") @db.VarChar(100)
  label       String?  @db.VarChar(255)
  tags        String   @default("") @db.VarChar(500)
  group       String   @default("General") @db.VarChar(100)
  apiKey      String   @db.VarChar(255)
  lastSeenAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reports        Report[]
  alerts         Alert[]
  messages       Message[]
  commands       Command[]
  serverMessages ServerMessage[]
  thresholds     AlertThreshold[]
  auditLogs      AuditLog[]

  @@map("computer")
}

model Report {
  id          String   @id @default(cuid()) @db.VarChar(30)
  computerId  String   @db.VarChar(30)
  computer    Computer @relation(fields: [computerId], references: [id], onDelete: Cascade)

  cpuUsage    Float
  cpuCores    Int?
  cpuSpeed    String?  @db.VarChar(100)
  cpuTemp     Float?

  ramTotal    Float
  ramUsed     Float
  ramUsage    Float

  diskTotal   Float
  diskUsed    Float
  diskUsage   Float
  diskDetails String?  @db.LongText

  networkUp   Boolean  @default(true)
  networkInfo String?  @db.LongText

  osInfo      String?  @db.Text
  uptime      Float?

  topProcesses String? @db.LongText
  eventLogs    String? @db.LongText
  software     String? @db.LongText
  antivirusStatus String? @db.Text

  printers        String? @db.LongText
  windowsLicense  String? @db.Text
  officeLicense   String? @db.Text
  startupPrograms String? @db.LongText
  sharedFolders   String? @db.LongText
  usbDevices      String? @db.LongText
  windowsUpdate   String? @db.LongText
  services        String? @db.LongText
  
  // Advanced Monitoring (Phase 4)
  printHistory    String? @db.LongText
  bandwidthUsage  String? @db.Text
  appUsage        String? @db.LongText

  createdAt   DateTime @default(now())

  @@index([computerId, createdAt])
  @@map("report")
}

model Message {
  id          String   @id @default(cuid()) @db.VarChar(30)
  computerId  String?  @db.VarChar(30)
  computer    Computer? @relation(fields: [computerId], references: [id], onDelete: Cascade)

  hostname    String   @db.VarChar(255)
  department  String?  @db.VarChar(100)
  ipAddress   String?  @db.VarChar(45)
  message     String   @db.Text
  read        Boolean  @default(false)
  readAt      DateTime?
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?
  reply       String?  @db.Text

  createdAt   DateTime @default(now())

  @@index([read])
  @@index([resolved])
  @@index([createdAt])
  @@map("message")
}

model Command {
  id          String   @id @default(cuid()) @db.VarChar(30)
  computerId  String   @db.VarChar(30)
  computer    Computer @relation(fields: [computerId], references: [id], onDelete: Cascade)

  action      String   @db.VarChar(100)
  params      String?  @db.Text
  status      String   @default("pending") @db.VarChar(20)
  result      String?  @db.LongText
  createdBy   String   @default("admin") @db.VarChar(100)

  createdAt   DateTime @default(now())
  executedAt  DateTime?

  @@index([computerId, status])
  @@index([status])
  @@map("command")
}

model Alert {
  id          String   @id @default(cuid()) @db.VarChar(30)
  computerId  String   @db.VarChar(30)
  computer    Computer @relation(fields: [computerId], references: [id], onDelete: Cascade)

  type        String   @db.VarChar(50)
  severity    String   @default("warning") @db.VarChar(20)
  message     String   @db.Text
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?

  createdAt   DateTime @default(now())

  @@index([computerId, createdAt])
  @@index([resolved])
  @@map("alert")
}

model ServerMessage {
  id          String   @id @default(cuid()) @db.VarChar(30)
  computerId  String   @db.VarChar(30)
  computer    Computer @relation(fields: [computerId], references: [id], onDelete: Cascade)

  message     String   @db.Text
  delivered   Boolean  @default(false)
  deliveredAt DateTime?

  createdAt   DateTime @default(now())

  @@index([computerId, delivered])
  @@map("servermessage")
}

model Program {
  id          String   @id @default(cuid()) @db.VarChar(30)
  imageUrl    String?  @db.VarChar(500)
  name        String   @db.VarChar(191)
  description String   @db.Text
  programPath String   @db.VarChar(500)
  downloadUrl String?  @db.VarChar(500)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@map("program")
}

model AlertThreshold {
  id          String   @id @default(cuid()) @db.VarChar(30)
  computerId  String   @db.VarChar(30)
  computer    Computer @relation(fields: [computerId], references: [id], onDelete: Cascade)

  cpuThreshold    Float @default(90)
  ramThreshold    Float @default(85)
  diskThreshold   Float @default(90)
  eventLogErrors  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([computerId])
  @@map("alertthreshold")
}

model AuditLog {
  id          String    @id @default(cuid()) @db.VarChar(30)
  userId      String?   @db.VarChar(30)
  action      String    @db.VarChar(100)
  details     String?   @db.Text
  ipAddress   String?   @db.VarChar(45)
  userAgent   String?   @db.Text
  computerId  String?   @db.VarChar(30)
  user        User?     @relation(fields: [userId], references: [id])
  computer    Computer? @relation(fields: [computerId], references: [id])
  
  createdAt   DateTime  @default(now())

  @@index([createdAt])
  @@index([userId])
  @@index([action])
  @@map("auditlog")
}
