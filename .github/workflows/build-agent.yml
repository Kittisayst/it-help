name: Build IT Monitor Agent

on:
    push:
        branches: [main]
        tags:
            - "v*"
        paths:
            - "agent/**"
    workflow_dispatch:

jobs:
    build:
        runs-on: windows-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  cd agent
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pyinstaller

            - name: Generate icons
              run: |
                  cd agent
                  python generate_icon.py

            - name: Build EXE with PyInstaller
              run: |
                  cd agent
                  pyinstaller --onefile --noconsole --name agent --icon=Icon_Logo.ico --clean --hidden-import pystray._win32 --hidden-import PIL agent.py

            - name: Compile Installer with Inno Setup
              run: |
                  cd agent
                  # ISCC is already in the PATH on windows-latest runners
                  ISCC.exe installer.iss

            - name: Create Release
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      agent/installer_output/*.exe
                      agent/dist/agent.exe
                  draft: false
                  prerelease: false

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: IT-Monitor-Agent-Installer
                  path: |
                      agent/installer_output/*.exe
                      agent/dist/agent.exe
