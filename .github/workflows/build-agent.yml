name: Build Agent EXE

on:
  push:
    branches: [main, master]
    paths:
      - 'agent/**'
      - '.github/workflows/build-agent.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r agent/requirements.txt
          pip install pyinstaller
        shell: cmd

      - name: Update version file
        run: |
          echo ${{ github.run_number }} > agent/version.txt
        shell: bash

      - name: Build EXE
        run: |
          cd agent
          pyinstaller --onefile --noconsole --name agent --icon=Icon_Logo.ico --clean --hidden-import pystray._win32 --hidden-import PIL --hidden-import PIL.ImageGrab --hidden-import PIL.Image agent.py
        shell: cmd

      - name: Generate icons
        run: |
          cd agent
          python generate_icon.py
        shell: cmd

      - name: Build Installer with Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
        with:
          path: agent/installer.iss
          options: /O+

      - name: Prepare distribution (ZIP for manual install)
        run: |
          mkdir dist\it-monitor-agent
          copy agent\dist\agent.exe dist\it-monitor-agent\
          copy agent\config.json dist\it-monitor-agent\
          copy agent\version.txt dist\it-monitor-agent\
          copy agent\install_service.bat dist\it-monitor-agent\
          copy agent\uninstall_service.bat dist\it-monitor-agent\
          copy agent\icon_green.ico dist\it-monitor-agent\
          copy agent\icon_yellow.ico dist\it-monitor-agent\
          copy agent\icon_red.ico dist\it-monitor-agent\
          copy agent\icon_gray.ico dist\it-monitor-agent\
        shell: cmd

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: it-monitor-agent-zip
          path: dist/it-monitor-agent/
          retention-days: 30

      - name: Upload Installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: it-monitor-agent-installer
          path: agent/installer_output/*.exe
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    # Release on every push and manual trigger

    steps:
      - name: Download ZIP artifact
        uses: actions/download-artifact@v4
        with:
          name: it-monitor-agent-zip
          path: it-monitor-agent

      - name: Download Installer artifact
        uses: actions/download-artifact@v4
        with:
          name: it-monitor-agent-installer
          path: installer

      - name: Create ZIP
        run: |
          cd it-monitor-agent
          zip -r ../it-monitor-agent.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: agent-v${{ github.run_number }}
          name: IT Monitor Agent v${{ github.run_number }}
          body: |
            ## IT Monitor Agent v${{ github.run_number }}
            
            ### üì¶ ‡∫ß‡∫¥‡∫ó‡∫µ‡∫ï‡∫¥‡∫î‡∫ï‡∫±‡ªâ‡∫á (‡ªÅ‡∫ô‡∫∞‡∫ô‡∫≥ - ‡∫á‡ªà‡∫≤‡∫ç‡∫ó‡∫µ‡ªà‡∫™‡∫∏‡∫î)
            1. ‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫•‡∫î `ITMonitorAgent-Setup-v1.0.exe`
            2. Run installer ‡ªÄ‡∫õ‡∫±‡∫ô Administrator
            3. ‡∫õ‡∫∞‡∫ï‡∫¥‡∫ö‡∫±‡∫î‡∫ï‡∫≤‡∫°‡∫Ç‡∫±‡ªâ‡∫ô‡∫ï‡∫≠‡∫ô‡∫Å‡∫≤‡∫ô‡∫ï‡∫¥‡∫î‡∫ï‡∫±‡ªâ‡∫á
            4. ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç config.json (‡∫ï‡∫±‡ªâ‡∫á API key ‡ªÅ‡∫•‡∫∞ server URL)
            5. Service ‡∫à‡∫∞‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î
            
            ### üìÅ ‡∫ß‡∫¥‡∫ó‡∫µ‡∫ï‡∫¥‡∫î‡∫ï‡∫±‡ªâ‡∫á‡ªÅ‡∫ö‡∫ö Manual (‡∫™‡∫≥‡∫•‡∫±‡∫ö‡∫ú‡∫π‡ªâ‡∫ä‡ªà‡∫Ω‡∫ß‡∫ä‡∫≤‡∫ô)
            1. ‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫•‡∫î `it-monitor-agent.zip`
            2. ‡ªÅ‡∫ï‡∫Å‡ªÑ‡∫ü‡∫•‡ªå‡ªÉ‡∫™‡ªà `C:\Program Files\ITMonitorAgent\`
            3. ‡ªÅ‡∫Å‡ªâ `config.json` (‡∫ï‡∫±‡ªâ‡∫á server_url, api_key, department)
            4. Run `install_service.bat` ‡ªÄ‡∫õ‡∫±‡∫ô Administrator
            
            ### üîÑ Auto-Update
            Agent ‡∫à‡∫∞‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö ‡ªÅ‡∫•‡∫∞ ‡∫≠‡∫±‡∫ö‡ªÄ‡∫î‡∫î‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î‡∫ó‡∫∏‡∫Å‡ªÜ 1 ‡∫ä‡∫ª‡ªà‡∫ß‡ªÇ‡∫°‡∫á
            
            ### üóëÔ∏è Uninstall
            - **Installer version**: ‡ªÉ‡∫ä‡ªâ Windows Settings ‚Üí Apps ‚Üí Uninstall
            - **Manual version**: Run `uninstall_service.bat` ‡ªÅ‡∫•‡ªâ‡∫ß‡∫•‡∫∂‡∫ö‡ªÇ‡∫ü‡∫•‡ªÄ‡∫î‡∫µ
          files: |
            installer/*.exe
            it-monitor-agent.zip
          draft: false
          prerelease: false
